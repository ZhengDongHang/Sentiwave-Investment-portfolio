import jieba
import os
import csv
import chardet
import pandas as pd
from tqdm import tqdm

# ==========================================
# é…ç½®å‚æ•°
# ==========================================
Emo_Dict = ['DLUT', 'Bian', 'Jiang'][0]  # é€‰æ‹©è¯å…¸ï¼šDLUT / Bian / Jiang
input_folder = '../data/test_data/'   # è¾“å…¥æ–‡ä»¶å¤¹ï¼šæ¯åªä¸ªè‚¡ä¸€ä¸ª CSV æ–‡ä»¶
output_folder = f'results/{Emo_Dict}/'  # è¾“å‡ºç›®å½•
os.makedirs(output_folder, exist_ok=True)

# ==========================================
# åŠ è½½æƒ…ç»ªè¯å…¸
# ==========================================
def load_words(dict_folder):
    pos_path = os.path.join(dict_folder, 'emo_dict', 'positive_words.txt')
    neg_path = os.path.join(dict_folder, 'emo_dict', 'negative_words.txt')

    def detect_encoding(file_path):
        with open(file_path, 'rb') as f:
            result = chardet.detect(f.read())
            return result['encoding']

    pos_encoding = detect_encoding(pos_path)
    neg_encoding = detect_encoding(neg_path)

    with open(pos_path, 'r', encoding=pos_encoding, errors='ignore') as f:
        positive_words = set(f.read().splitlines())
    with open(neg_path, 'r', encoding=neg_encoding, errors='ignore') as f:
        negative_words = set(f.read().splitlines())

    return positive_words, negative_words

positive_words, negative_words = load_words(Emo_Dict)

# ==========================================
# æƒ…ç»ªå¾—åˆ†è®¡ç®—å‡½æ•°
# ==========================================
def calculate_sentiment(text):
    if isinstance(text, float):
        text = str(text)
    words = jieba.lcut(text)
    pos_count = sum(1 for w in words if w in positive_words)
    neg_count = sum(1 for w in words if w in negative_words)
    total_count = len(words)
    if total_count == 0 or (pos_count + neg_count) == 0:
        return 0
    pos_ratio = pos_count / total_count
    neg_ratio = neg_count / total_count
    return (pos_ratio - neg_ratio) / (pos_ratio + neg_ratio)

# ==========================================
# éå†æ¯åªä¸ªè‚¡ CSV æ–‡ä»¶å¹¶å¤„ç†
# ==========================================
csv_files = [f for f in os.listdir(input_folder) if f.endswith('.csv')]
print(f"ğŸ“‚ å…±å‘ç° {len(csv_files)} ä¸ª CSV æ–‡ä»¶")

for file_name in tqdm(csv_files, desc="ğŸ“Š æ­£åœ¨å¤„ç†"):
    input_path = os.path.join(input_folder, file_name)
    output_path = os.path.join(output_folder, file_name)

    try:
        df = pd.read_csv(input_path, encoding='utf-8')

        if 'æ–‡æœ¬' not in df.columns:
            print(f"âš ï¸ æ–‡ä»¶ {file_name} ç¼ºå°‘ 'æ–‡æœ¬' åˆ—ï¼Œå·²è·³è¿‡")
            continue

        texts = df['æ–‡æœ¬'].fillna("").astype(str).tolist()
        sentiments = [calculate_sentiment(text) for text in texts]

        # å¤åˆ¶ä¸‰åˆ—
        df['ä¸Šè¯ç»¼åˆæƒ…ç»ªå€¼'] = sentiments
        df['æ²ªæ·±300æƒ…ç»ªå€¼'] = sentiments
        df['åˆ›ä¸šæ¿æƒ…ç»ªå€¼'] = sentiments

        df.to_csv(output_path, index=False, encoding='utf-8-sig')

    except Exception as e:
        print(f"âŒ æ–‡ä»¶ {file_name} å¤„ç†å¤±è´¥ï¼š{e}")

print(f"âœ… æƒ…ç»ªè¯å…¸åˆ†æï¼ˆ{Emo_Dict}ï¼‰å®Œæˆï¼Œç»“æœå·²ä¿å­˜è‡³ {output_folder}")
